


<!DOCTYPE html>
<html id="htmlId">
<head>
  <title>Coverage Report > VerifiedHgvsVariantAnnotationService</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.cbioportal.genome_nexus.service.internal</a>
</div>

<h1>Coverage Summary for Class: VerifiedHgvsVariantAnnotationService (org.cbioportal.genome_nexus.service.internal)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">VerifiedHgvsVariantAnnotationService</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    90%
  </span>
  <span class="absValue">
    (9/10)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    77%
  </span>
  <span class="absValue">
    (47/61)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/*
&nbsp; * Copyright (c) 2021 Memorial Sloan-Kettering Cancer Center.
&nbsp; *
&nbsp; * This library is distributed in the hope that it will be useful, but WITHOUT
&nbsp; * ANY WARRANTY, WITHOUT EVEN THE IMPLIED WARRANTY OF MERCHANTABILITY OR FITNESS
&nbsp; * FOR A PARTICULAR PURPOSE. The software and documentation provided hereunder
&nbsp; * is on an &quot;as is&quot; basis, and Memorial Sloan-Kettering Cancer Center has no
&nbsp; * obligations to provide maintenance, support, updates, enhancements or
&nbsp; * modifications. In no event shall Memorial Sloan-Kettering Cancer Center be
&nbsp; * liable to any party for direct, indirect, special, incidental or
&nbsp; * consequential damages, including lost profits, arising out of the use of this
&nbsp; * software and its documentation, even if Memorial Sloan-Kettering Cancer
&nbsp; * Center has been advised of the possibility of such damage.
&nbsp; */
&nbsp;
&nbsp;/*
&nbsp; * This file is part of cBioPortal.
&nbsp; *
&nbsp; * cBioPortal is free software: you can redistribute it and/or modify
&nbsp; * it under the terms of the GNU Affero General Public License as
&nbsp; * published by the Free Software Foundation, either version 3 of the
&nbsp; * License.
&nbsp; *
&nbsp; * This program is distributed in the hope that it will be useful,
&nbsp; * but WITHOUT ANY WARRANTY; without even the implied warranty of
&nbsp; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
&nbsp; * GNU Affero General Public License for more details.
&nbsp; *
&nbsp; * You should have received a copy of the GNU Affero General Public License
&nbsp; * along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
&nbsp;*/
&nbsp;
&nbsp;package org.cbioportal.genome_nexus.service.internal;
&nbsp;
&nbsp;import java.util.*;
&nbsp;import org.apache.commons.logging.Log;
&nbsp;import org.apache.commons.logging.LogFactory;
&nbsp;import org.cbioportal.genome_nexus.model.VariantAnnotation;
&nbsp;import org.cbioportal.genome_nexus.service.*;
&nbsp;import org.cbioportal.genome_nexus.service.cached.CachedVariantAnnotationFetcher;
&nbsp;import org.cbioportal.genome_nexus.service.exception.VariantAnnotationNotFoundException;
&nbsp;import org.cbioportal.genome_nexus.service.exception.VariantAnnotationWebServiceException;
&nbsp;import org.cbioportal.genome_nexus.service.internal.HgvsVariantAnnotationService;
&nbsp;import org.cbioportal.genome_nexus.util.GenomicVariantUtil;
&nbsp;import org.springframework.beans.factory.annotation.*;
&nbsp;import org.springframework.context.annotation.Lazy;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;
&nbsp;@Service
&nbsp;public class VerifiedHgvsVariantAnnotationService implements VariantAnnotationService
&nbsp;{
<b class="fc">&nbsp;    private static final Log LOG = LogFactory.getLog(VerifiedHgvsVariantAnnotationService.class);</b>
&nbsp;    private final HgvsVariantAnnotationService hgvsVariantAnnotationService;
&nbsp;
&nbsp;    @Autowired
&nbsp;    public VerifiedHgvsVariantAnnotationService(
&nbsp;        HgvsVariantAnnotationService hgvsVariantAnnotationService)
<b class="fc">&nbsp;    {</b>
<b class="fc">&nbsp;        this.hgvsVariantAnnotationService = hgvsVariantAnnotationService;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public VariantAnnotation getAnnotation(String variant)
&nbsp;            throws VariantAnnotationNotFoundException, VariantAnnotationWebServiceException
&nbsp;    {
<b class="fc">&nbsp;        VariantAnnotation annotation = hgvsVariantAnnotationService.getAnnotation(variant);</b>
<b class="fc">&nbsp;        VariantAnnotation verifiedAnnotation = verifyOrFailAnnotation(annotation);</b>
<b class="fc">&nbsp;        return verifiedAnnotation;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public List&lt;VariantAnnotation&gt; getAnnotations(List&lt;String&gt; variants)
&nbsp;    {
<b class="nc">&nbsp;        List&lt;VariantAnnotation&gt; annotations = hgvsVariantAnnotationService.getAnnotations(variants);</b>
<b class="nc">&nbsp;        for (int index = 0; index &lt; annotations.size(); index = index + 1) {</b>
<b class="nc">&nbsp;            VariantAnnotation annotation = annotations.get(index);</b>
<b class="nc">&nbsp;            VariantAnnotation verifiedAnnotation = verifyOrFailAnnotation(annotation);</b>
<b class="nc">&nbsp;            annotations.set(index, verifiedAnnotation);</b>
&nbsp;        }
<b class="nc">&nbsp;        return annotations;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public VariantAnnotation getAnnotation(String variant, String isoformOverrideSource, Map&lt;String, String&gt; token, List&lt;String&gt; fields)
&nbsp;            throws VariantAnnotationWebServiceException, VariantAnnotationNotFoundException
&nbsp;    {
<b class="fc">&nbsp;        VariantAnnotation annotation = hgvsVariantAnnotationService.getAnnotation(variant, isoformOverrideSource, token, fields);</b>
<b class="fc">&nbsp;        VariantAnnotation verifiedAnnotation = verifyOrFailAnnotation(annotation);</b>
<b class="fc">&nbsp;        return verifiedAnnotation;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public List&lt;VariantAnnotation&gt; getAnnotations(List&lt;String&gt; variants, String isoformOverrideSource, Map&lt;String, String&gt; token, List&lt;String&gt; fields)
&nbsp;    {
<b class="fc">&nbsp;        List&lt;VariantAnnotation&gt; annotations = hgvsVariantAnnotationService.getAnnotations(variants, isoformOverrideSource, token, fields);</b>
<b class="fc">&nbsp;        for (int index = 0; index &lt; annotations.size(); index = index + 1) {</b>
<b class="fc">&nbsp;            VariantAnnotation annotation = annotations.get(index);</b>
<b class="fc">&nbsp;            VariantAnnotation verifiedAnnotation = verifyOrFailAnnotation(annotation);</b>
<b class="fc">&nbsp;            annotations.set(index, verifiedAnnotation);</b>
&nbsp;        }
<b class="fc">&nbsp;        return annotations;</b>
&nbsp;    }
&nbsp;
&nbsp;    private VariantAnnotation verifyOrFailAnnotation(VariantAnnotation annotation)
&nbsp;    {
<b class="fc">&nbsp;        String originalVariantQuery = annotation.getOriginalVariantQuery(); // save for failed response</b>
<b class="fc">&nbsp;        String originalVariant = annotation.getVariant(); // save for failed response</b>
<b class="fc">&nbsp;        String originalQuery = originalVariantQuery;</b>
<b class="fc">&nbsp;        if (originalVariantQuery == null || originalVariantQuery.length() == 0) {</b>
<b class="fc">&nbsp;            originalQuery = originalVariant;</b>
&nbsp;        }
<b class="fc">&nbsp;        String providedReferenceAllele = GenomicVariantUtil.providedReferenceAlleleFromHgvs(originalQuery);</b>
<b class="fc">&nbsp;        if (providedReferenceAllele.length() == 0) {</b>
&nbsp;            // no comparison possible : allele not specified in query
<b class="fc">&nbsp;            return annotation;</b>
&nbsp;        }
<b class="fc">&nbsp;        LOG.debug(&quot;verifying providedReferenceAllele : &#39;&quot; + providedReferenceAllele + &quot;&#39;&quot;);</b>
<b class="fc">&nbsp;        String responseReferenceAllele = getReferenceAlleleFromAnnotation(annotation);</b>
<b class="fc">&nbsp;        if (responseReferenceAllele.length() != providedReferenceAllele.length()) {</b>
&nbsp;            // for altered length Deletion-Insertion responses, recover full reference allele with followup query
<b class="fc">&nbsp;            String followUpVariant = constructFollowUpQuery(originalQuery);</b>
<b class="fc">&nbsp;            if (followUpVariant.length() &gt; 0) {</b>
&nbsp;                try {
<b class="nc">&nbsp;                    LOG.debug(&quot;performing followup annotation request to get VEP genome assembly sequence : &#39;&quot; + providedReferenceAllele + &quot;&#39;&quot;);</b>
<b class="nc">&nbsp;                    VariantAnnotation followUpAnnotation = hgvsVariantAnnotationService.getAnnotation(followUpVariant);</b>
<b class="nc">&nbsp;                    responseReferenceAllele = getReferenceAlleleFromAnnotation(followUpAnnotation);</b>
<b class="nc">&nbsp;                } catch (VariantAnnotationNotFoundException|VariantAnnotationWebServiceException vae) {</b>
&nbsp;                    // followup validation failed - could not verify provided allele, so accept failure
<b class="nc">&nbsp;                    LOG.debug(&quot;followup annotation request failed - Reference_Allele could not be verified&quot;);</b>
<b class="nc">&nbsp;                }</b>
&nbsp;            }
&nbsp;        }
<b class="fc">&nbsp;        if (providedReferenceAllele.equals(responseReferenceAllele)) {</b>
&nbsp;            // validation complete
<b class="fc">&nbsp;            return annotation;</b>
&nbsp;        }
&nbsp;        // return annotation failure
<b class="fc">&nbsp;        return createFailedAnnotation(originalVariantQuery, originalVariant);</b>
&nbsp;    }
&nbsp;
&nbsp;    private String constructFollowUpQuery(String originalQuery)
&nbsp;    {
&nbsp;        // create a deletion variant covering the referenced genome positions
&nbsp;        // this code should only run for delins variants where part of the TumorSeq allele matches the reference genome
<b class="fc">&nbsp;        String followUpQuery = originalQuery.replaceFirst(&quot;ins.*|del.*&quot;,&quot;&quot;);</b>
<b class="fc">&nbsp;        if (followUpQuery.length() == originalQuery.length()) {</b>
<b class="fc">&nbsp;            return &quot;&quot;; // unexpectantly called constructFollowUpQuery on non-delins hgvs query -- this annotation will fail</b>
&nbsp;        }
<b class="nc">&nbsp;        return followUpQuery + &quot;del&quot;;</b>
&nbsp;    }
&nbsp;
&nbsp;    private String getReferenceAlleleFromAnnotation(VariantAnnotation annotation)
&nbsp;    {
<b class="fc">&nbsp;        String alleleString = annotation.getAlleleString();</b>
<b class="fc">&nbsp;        if (alleleString == null) {</b>
&nbsp;            // maybe original annotation attempt failed
<b class="fc">&nbsp;            return &quot;&quot;;</b>
&nbsp;        }
<b class="fc">&nbsp;        int slashPosition = alleleString.indexOf(&#39;/&#39;);</b>
<b class="fc">&nbsp;        if (slashPosition == -1 || slashPosition == 0) {</b>
<b class="nc">&nbsp;            return &quot;&quot;;</b>
&nbsp;        }
<b class="fc">&nbsp;        return alleleString.substring(0,slashPosition);</b>
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;    private VariantAnnotation createFailedAnnotation(String originalVariantQuery, String originalVariant)
&nbsp;    {
<b class="fc">&nbsp;        VariantAnnotation annotation = new VariantAnnotation();</b>
<b class="fc">&nbsp;        if (originalVariantQuery != null &amp;&amp; originalVariantQuery.length() &gt; 0) {</b>
<b class="fc">&nbsp;            annotation.setOriginalVariantQuery(originalVariantQuery);</b>
&nbsp;        }
<b class="fc">&nbsp;        if (originalVariant != null &amp;&amp; originalVariant.length() &gt; 0) {</b>
<b class="fc">&nbsp;            annotation.setVariant(originalVariant);</b>
&nbsp;        }
<b class="fc">&nbsp;        annotation.setSuccessfullyAnnotated(false);</b>
<b class="fc">&nbsp;        return annotation;</b>
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2024-04-18 22:00</div>
</div>
</body>
</html>
